(()=>{function v(...u){let t={runtimeParams:A,compilerParams:I,parserParams:E},e;for(;e=u.shift();){let{runtimeParams:r={},compilerParams:{globalsNoObserve:i=[],globalsOnlyPathsExcept:s=[],...n}={},parserParams:o={}}=e;t={runtimeParams:{...t.runtimeParams,...r},compilerParams:{...t.compilerParams,globalsNoObserve:[...t.compilerParams.globalsNoObserve,...i],globalsOnlyPathsExcept:[...t.compilerParams.globalsOnlyPathsExcept,...s],...n},parserParams:{...t.parserParams,...o}},u.devMode}return t}var E={ecmaVersion:"2020",allowReturnOutsideFunction:!0,allowAwaitOutsideFunction:!0,allowSuperOutsideMethod:!0,preserveParens:!1,locations:!1},I={globalsNoObserve:["arguments","debugger"],globalsOnlyPathsExcept:[],originalSource:!0,locations:!0,compact:2},A={apiVersion:2};function O(u,t=!1){let e=u.split(/\n/g);if(e.length>1){for(;!e[0].trim().length;)e.shift();let r=e[t?1:0].split(/[^\s]/)[0].length;if(r)return e.map((i,s)=>{let n=i.substring(0,r);return n.trim().length?n.trim()==="}"&&s===e.length-1?"}":i:i.substring(r)}).join(`
`)}return u}var m=(u,t)=>u instanceof Promise?u.then(t):t(u);var j=new Map;function S(u,t){if(typeof t=="object"&&t){j.set(u,t);return}let e=j.get(u);return m(e,r=>r&&(t?r[t]:r))}var y=class{constructor(t,e,r,i={},s=null,n=null){this.ownerReflex=t,this.graph=e,this.callee=r,this.params=t?i:{...i,isReflexFunction:!0},this.exits=n||new Map,this.$thread=s||{entries:new Map,sequence:[],ownerReflex:this},this.subReflexes=new Map,this.observers=[],this.reflex=function(o,l,a=null,h=null){if(!this.graph.subReflexes[o])throw new Error(`[${this.graph.type}:${this.graph.lineage}]: Graph not found for child reflex ${o}.`);let f=this.graph.subReflexes[o],c={...this.params,isIterationReflex:arguments.length===3,iterationId:arguments.length===3&&l,isFunctionReflex:arguments.length===4,functionType:arguments.length===4&&l,isReflexFunction:arguments.length===4&&a,functionScope:this.params.isFunctionReflex&&this.graph.lineage||this.params.functionScope};if(c.isIterationReflex){let x=a,g=new y(this,f,x,c,this.$thread,this.exits),w=this.subReflexes.get(o);return w||(w=new Map,this.subReflexes.set(o,w)),w.has(c.iterationId)&&w.get(c.iterationId).dispose(),w.set(c.iterationId,g),g.call()}let p,b,d;if(this.subReflexes.has(o)&&this.subReflexes.get(o).dispose(),c.isFunctionReflex){p=h;let x=()=>new y(this,f,p,c);if(c.functionType!=="FunctionDeclaration")d=this.createFunction(x);else{let g=x();c.apiVersion>1?(d=function(...w){let R=g.call(this,...w);return R=m(R,$=>[R,g.thread.bind(g),g]),g=x(),R},d.target=g):d=g}}else p=l,b=new y(this,f,p,c,this.$thread,this.exits),this.subReflexes.set(o,b),d=b.call();return d}.bind(this),this.reflex.memo=Object.create(null),this.ownerReflex&&!["FunctionDeclaration","FunctionExpression"].includes(this.graph.type)&&(this.reflex.args=this.ownerReflex.reflex.args),this.reflex.exiting=function(o,l){if(!arguments.length)return this.exits.size;let a=this.exits.get(o)===l;return a&&this.exits.clear(),a}.bind(this),this.reflex.exit=function(o,l){this.exits.set(o,l)}.bind(this),this.reflex.functions=new Map,this.reflex.functions.declaration=(o,l)=>{this.reflex.functions.set(o,l),this.applyReflection(o,typeof l=="function"?l.target:l)}}fire(t,e,r){if(!this.ownerReflex)return;let i=this.ownerReflex.fire(t,e,r);return this.observers.forEach(s=>{s.reflexUrl===t&&s.callback(e,r)}),i}observe(t,e){!this.params.isFunctionReflex||this.observers.push({reflexUrl:t,callback:e})}call(t,...e){if(this.disposed)throw new Error(`[${this.graph.type}:${this.graph.lineage}]: Instance not runable after having been disposed.`);this.ownerReflex||(this.reflex.args=e,Object.defineProperty(this.reflex.args,Symbol.toStringTag,{value:"Arguments"}));let r=this.callee.call(t,this.reflex,...e);if(this.graph.$sideEffects)for(let i in this.graph.effects)for(let s of this.graph.effects[i].refs)this.buildThread([],s,[],0,!0);return m(r,()=>{if(!this.ownerReflex||this.params.isFunctionReflex){let i=this.exits.get("return");if(this.exits.clear(),i!==void 0)return i}return r})}iterate(t=[]){if(this.disposed)return!1;if(!["ForOfStatement","ForInStatement"].includes(this.graph.type)||this.subReflexes.size!==1)throw new Error(`Reflex ${this.graph.lineage} is not an iterator.`);let[[,e]]=this.subReflexes,r;if(!t.length||t.includes("length")&&this.graph.type==="ForOfStatement")for(let[,i]of e)r=m(r,()=>i.call());else for(let i of t){let s=e.get(i)||e.get(parseInt(i));!s||(r=m(r,()=>s.call()))}return r}thread(...t){if(this.disposed)return!1;this.$thread.active=!0;for(let e in this.graph.effects)for(let r of this.graph.effects[e].refs)for(let i of t){i=Array.isArray(i)?i:[i];let[s,n,o]=this.matchRefs(i,r);!s||this.buildThread(i,r,o,n)}return this.runThread()}runThread(){let t=(s,n)=>{if(["ForOfStatement","ForInStatement"].includes(s.graph.type)&&n.every(o=>o.executionPlan.isIterationReflexTarget)){let o=n.map(l=>l.executionPlan.iterationTarget);return this.fire(s.graph.lineage,"iterating",n),s.iterate(o)}return this.fire(s.graph.lineage,"executing",n),s.call()},e,r,i;for(;(r=this.$thread.sequence.shift())&&(i=[...this.$thread.entries.get(r)])&&this.$thread.entries.delete(r);)e=m(e,()=>{if(r.disposed||!r.filterRefs(i).length)return;this.$thread.current=r;let s=t(r,i);return m(s,()=>{for(let n of i)[].concat(n.executionPlan.assigneeRef||n.executionPlan.assigneeRefs||[]).forEach(o=>{r.buildThread([],o,[],0)})}),s});return m(e,()=>{let s=this.exits.get("return");return this.exits.clear(),this.$thread.current=null,this.$thread.active=!1,s})}buildThread(t,e,r,i=0,s=!1){let n=i>0;if(this.ownerReflex){if(!this.compute(r)||e.condition!==void 0&&!this.assert(e.condition))return}else n||(n=r.length||e.condition!==void 0);let o=s?e.$subscriptions:e.subscriptions;Object.keys(o).forEach(l=>{let[a,h]=l.split(":"),f=p=>{!p||p.selectRefs(h,o[l],n?t:null)},c=this.locate(a);Array.isArray(c)?c.forEach(f):f(c)})}selectRefs(t,e,r=null){let i=this.$thread,s=this.graph.signals[t],n=(l,a)=>l.graph.lineage.localeCompare(a.graph.lineage,void 0,{numeric:!0}),o=(l,a=[],h={})=>{if(!i.active||i.current&&n(this,i.current)<0)return;let f=i.entries.get(this);if(f||(f=new Set,i.entries.set(this,f),i.sequence.push(this),i.sequence.sort(n)),f.add({...l,computes:a,executionPlan:h}),!h.assigneeRef&&["VariableDeclaration","AssignmentExpression"].includes(this.graph.type)){h.assigneeRefs=[];for(let c in this.graph.effects)h.assigneeRefs.push(...this.graph.effects[c].refs)}};for(let l of e){let a=s.refs[l];if(!r){o(a);continue}let[h,f,c]=this.matchRefs(r,a);if(!h)continue;if(f<=0){o(a,c);continue}let p=r.slice(-f),b="assignee"in s?this.graph.effects[s.assignee]:null;if(b){b.refs.forEach(d=>{if(d.depth.length){let[x,g,w]=this.matchRefs(p,d.depth),R=c.concat(w);if(x&&g>0){let $=d.path.concat(p.slice(-g));this.buildThread($,d,R,g)}else x&&o(a,R,{assigneeRef:d})}else{let x=d.path.concat(p);this.buildThread(x,d,c,f)}});continue}if(f===1&&this.graph.type==="ForOfStatement"){o(a,c,{isIterationReflexTarget:!0,iterationTarget:p[0]});continue}if(f===1&&this.graph.type==="ForInStatement"){o(a,c,{isIterationReflexTarget:!0,iterationTarget:p[0]});continue}}}filterRefs(t){return t.filter(e=>{if(!!this.compute(e.computes)&&!(e.condition!==void 0&&!this.assert(e.condition)))return!0})}matchRefs(t,e){let r,i,s,n;Array.isArray(t)?(r=t,i=t.dotSafe?t.join("."):void 0):(r=t.path,i=t.$path),Array.isArray(e)?(s=e,n=e.dotSafe?e.join("."):void 0):(s=e.path,n=e.$path);let o=r.length-s.length;if(o>0&&([r,s,i,n]=[s,r,n,i]),i&&n)return[`${n}.`.startsWith(`${i}.`),o,[]];let l=[],a=f=>typeof f=="object"?f.name:f,h=(f,c)=>{if(!f||!c)return!1;let p=typeof f=="object"&&"memoId"in f,b=typeof c=="object"&&"memoId"in c;return p||b?(l.push(d=>(p?d[f.memoId]:a(f))===(b?d[c.memoId]:a(c))),!0):a(f)===a(c)};return[r.reduce((f,c,p)=>f&&h(c,s[p]),!0),o,l]}locate(t){let e=this.graph.lineage+"/",r=t+"/";if(r===e)return this;if(r.startsWith(e)){let i=t.slice(e.length).split("/"),s=this.subReflexes.get(parseInt(i.shift()));if(i.length){if(s instanceof Map)return Array.from(s).reduce((n,[o,l])=>n.concat(l.locate(t)),[]);if(s)return s.locate(t)}return s}if(this.ownerReflex)return this.ownerReflex.locate(t)}compute(t){return!t.some(e=>e(this.reflex.memo)===!1)}assert(t){if(typeof t=="string"&&t.includes(":")){let[i,s]=t.split(":");return this.locate(i).assert(s)}let e=this.graph.conditions[t],r=this.reflex.memo;return typeof e.parent<"u"&&!this.assert(e.parent)?!1:typeof e.switch<"u"?e.cases.some(i=>r[i]===r[e.switch]):typeof e.whenNot<"u"?!r[e.whenNot]:typeof e.when<"u"?r[e.when]:!0}dispose(){this.params.isFunctionReflex||(this.subReflexes.forEach((t,e)=>{t instanceof Map?(t.forEach(r=>r.dispose()),t.clear()):t.dispose()}),this.subReflexes.clear(),delete this.ownerReflex,delete this.callee,delete this.params,delete this.reflex.memo,this.disposed=!0)}createFunction(t,e=void 0){let r=t(),i=function(n,...o){let l=n.call(this===void 0?e:this,...o);return n.params.isReflexFunction&&n.params.apiVersion>1&&(l=m(l,a=>[a,n.thread.bind(n),n]),r=t(r)),l},s=r instanceof Promise||r.callee instanceof async function(){}.constructor?async function(){return m(r,n=>i.call(this,n,...arguments))}:function(){return i.call(this,r,...arguments)};return m(r,n=>{this.applyReflection(s,n)}),S(s,m(r,n=>{let o={type:n.params.functionType||"Program",apiVersion:n.params.apiVersion||1,isReflexFunction:n.params.isReflexFunction,sideEffects:n.graph.sideEffects||!1,locations:n.graph.locations||[]};if(n.params.isReflexFunction){o.dependencies=[];for(let[l,a]of Object.entries(n.graph.effects))o.dependencies.push(...a.refs.map(h=>h.path.map(f=>"name"in f?f.name:1/0)))}return o})),s}applyReflection(t,e){Object.defineProperty(e.callee,"length",{configurable:!0,value:e.callee.length-1});let r=e.callee.toString();Object.defineProperty(e.callee,"toString",{configurable:!0,value:(s=!1)=>!s&&e.graph.originalSource?e.graph.originalSource:r});let i={name:e.callee.name,length:e.callee.length,toString:e.callee.toString};e.params.isReflexFunction&&(e.params.apiVersion>1||(i={...i,thread:e.thread.bind(e),dispose:e.dispose.bind(e),runtime:e})),Object.keys(i).forEach(s=>{Object.defineProperty(t,s,{configurable:!0,value:i[s]})})}};var F=class extends y{static create(t,e=[],r={}){let s=r.async||t.graph.hoistedAwaitKeyword?Object.getPrototypeOf(async function(){}).constructor:Function,n=r.compileFunction?r.compileFunction(t.source,[t.identifier+""].concat(e)):new s(t.identifier+"",...e,t.source);return t.graph.locations=t.locations,new this(null,t.graph,n,r)}static createFunction(t,e,r=[],i={},s,n=null){i={...i,functionType:"Constructor"},e instanceof Promise&&(i={...i,async:!0});let o=a=>a?new this(null,a.graph,a.callee,i):m(e,h=>l(this.create(h,r,i))),l=a=>{if(a.graph.originalSource&&!a.graph.originalSourceModified){let h=`${i.async||a.graph.hoistedAwaitKeyword?"async ":""}function ${t||"anonymous"}`,f=a.graph.originalSource.split(/\n/g).map(c=>`    ${c}`).join(`
`);a.graph.originalSource=`${h}(${r.join(", ")}) {
${f}
}`,a.graph.originalSourceModified=!0}return t&&Object.defineProperty(a.callee,"name",{configurable:!0,value:t}),a};return this.prototype.createFunction(o,s)}};function P(...u){if(typeof window!="object")throw new Error("No window in context.");let t=v(typeof u[u.length-1]=="object"?u.pop():{}),e=O(u.pop()||""),r=u,i=s=>F.createFunction(void 0,s,r,t.runtimeParams,this,e);if(window.webqit?.ReflexCompiler&&!t.runtimeParams.async){let{parse:s,compile:n}=window.webqit.ReflexCompiler,o=s(e,t.parserParams);return i(n(o,t.compilerParams))}if(window.webqit=window.webqit||{},!window.webqit.ReflexCompilerWorker){let o=`
        const compilerUrls = [ '${(document.querySelector('meta[name="reflex-compiler-url"]')?.content.split(",")||[]).concat("https://unpkg.com/@webqit/reflex-functions/dist/compiler.js").join("','")}' ];
        ( function importScript() {
            try { importScripts( compilerUrls.shift().trim() ) } catch( e ) { if ( compilerUrls.length ) { importScript(); } }
        } )();
        const { parse, compile } = self.webqit.ReflexCompiler;
        self.onmessage = e => {
            const { source, params } = e.data;
            const ast = parse( source, params.parserParams );
            const compilation = compile( ast, params.compilerParams );
            compilation.identifier = compilation.identifier.toString();
            e.ports[ 0 ]?.postMessage( compilation );
        };`;window.webqit.ReflexCompilerWorker=new Worker(`data:text/javascript;base64,${btoa(o)}`)}return i(new Promise(s=>{let n=new MessageChannel;webqit.ReflexCompilerWorker.postMessage({source:e,params:t},[n.port2]),n.port1.onmessage=o=>s(o.data)}))}Object.defineProperty(P,"inspect",{value:S});self.webqit||(self.webqit={});self.webqit.ReflexFunction=P;})();
//# sourceMappingURL=lite.js.map
