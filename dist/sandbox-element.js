(()=>{function $(...p){let e={runtimeParams:k,compilerParams:I,parserParams:A},t;for(;t=p.shift();){let{runtimeParams:i={},compilerParams:{globalsNoObserve:r=[],globalsOnlyPathsExcept:n=[],...s}={},parserParams:o={}}=t;e={runtimeParams:{...e.runtimeParams,...i},compilerParams:{...e.compilerParams,globalsNoObserve:[...e.compilerParams.globalsNoObserve,...r],globalsOnlyPathsExcept:[...e.compilerParams.globalsOnlyPathsExcept,...n],...s},parserParams:{...e.parserParams,...o}},p.devMode}return e}var A={ecmaVersion:"2020",allowReturnOutsideFunction:!0,allowAwaitOutsideFunction:!0,allowSuperOutsideMethod:!0,preserveParens:!1,locations:!1},I={globalsNoObserve:["arguments","debugger"],globalsOnlyPathsExcept:[],originalSource:!0,locations:!0,compact:2},k={apiVersion:2};function O(p,e=!1){let t=p.split(/\n/g);if(t.length>1){for(;!t[0].trim().length;)t.shift();let i=t[e?1:0].split(/[^\s]/)[0].length;if(i)return t.map((r,n)=>{let s=r.substring(0,i);return s.trim().length?s.trim()==="}"&&n===t.length-1?"}":r:r.substring(i)}).join(`
`)}return p}var m=(p,e)=>p instanceof Promise?p.then(e):e(p);var M=new Map;function x(p,e,t=void 0){let i=M.get(p);if(arguments.length>2){i||(i=new Map,M.set(p,i)),i.set(e,t);return}return i&&i.get(e)}var C=class{constructor(e,t,i,r={},n=null,s=null){this.ownerContract=e,this.graph=t,this.callee=i,this.params=e?r:{...r,isContractFunction:!0},this.exits=s||new Map,this.$thread=n||{entries:new Map,sequence:[],ownerContract:this},this.subContracts=new Map,this.observers=[],this.contract=function(o,l,u=null,h=null){if(!this.graph.subContracts[o])throw new Error(`[${this.graph.type}:${this.graph.lineage}]: Graph not found for child contract ${o}.`);let a=this.graph.subContracts[o],c={...this.params,isIterationContract:arguments.length===3,iterationId:arguments.length===3&&l,isFunctionContract:arguments.length===4,functionType:arguments.length===4&&l,isContractFunction:arguments.length===4&&u,functionScope:this.params.isFunctionContract&&this.graph.lineage||this.params.functionScope};if(c.isIterationContract){let b=u,g=new C(this,a,b,c,this.$thread,this.exits),w=this.subContracts.get(o);return w||(w=new Map,this.subContracts.set(o,w)),w.has(c.iterationId)&&w.get(c.iterationId).dispose(),w.set(c.iterationId,g),g.call()}let f,y,d;if(this.subContracts.has(o)&&this.subContracts.get(o).dispose(),c.isFunctionContract){f=h;let b=()=>new C(this,a,f,c);if(c.functionType!=="FunctionDeclaration")d=this.createFunction(b);else{let g=b();c.apiVersion>1?(d=function(...w){let v=g.call(this,...w);return v=m(v,P=>[v,g.thread.bind(g),g]),g=b(),v},d.target=g):d=g}}else f=l,y=new C(this,a,f,c,this.$thread,this.exits),this.subContracts.set(o,y),d=y.call();return d}.bind(this),this.contract.memo=Object.create(null),this.ownerContract&&!["FunctionDeclaration","FunctionExpression"].includes(this.graph.type)&&(this.contract.args=this.ownerContract.contract.args),this.contract.exiting=function(o,l){if(!arguments.length)return this.exits.size;let u=this.exits.get(o)===l;return u&&this.exits.clear(),u}.bind(this),this.contract.exit=function(o,l){this.exits.set(o,l)}.bind(this),this.contract.functions=new Map,this.contract.functions.declaration=(o,l)=>{this.contract.functions.set(o,l),this.applyReflection(o,typeof l=="function"?l.target:l)}}fire(e,t,i){if(!this.ownerContract)return;let r=this.ownerContract.fire(e,t,i);return this.observers.forEach(n=>{n.contractUrl===e&&n.callback(t,i)}),r}observe(e,t){!this.params.isFunctionContract||this.observers.push({contractUrl:e,callback:t})}call(e,...t){if(this.disposed)throw new Error(`[${this.graph.type}:${this.graph.lineage}]: Instance not runable after having been disposed.`);this.ownerContract||(this.contract.args=t,Object.defineProperty(this.contract.args,Symbol.toStringTag,{value:"Arguments"}));let i=this.callee.call(e,this.contract,...t);if(this.graph.$sideEffects)for(let r in this.graph.effects)for(let n of this.graph.effects[r].refs)this.buildThread([],n,[],0,!0);return m(i,()=>{if(!this.ownerContract||this.params.isFunctionContract){let r=this.exits.get("return");if(this.exits.clear(),r!==void 0)return r}return i})}iterate(e=[]){if(this.disposed)return!1;if(!["ForOfStatement","ForInStatement"].includes(this.graph.type)||this.subContracts.size!==1)throw new Error(`Contract ${this.graph.lineage} is not an iterator.`);let[[,t]]=this.subContracts,i;if(!e.length||e.includes("length")&&this.graph.type==="ForOfStatement")for(let[,r]of t)i=m(i,()=>r.call());else for(let r of e){let n=t.get(r)||t.get(parseInt(r));!n||(i=m(i,()=>n.call()))}return i}thread(...e){if(this.disposed)return!1;this.$thread.active=!0;for(let t in this.graph.effects)for(let i of this.graph.effects[t].refs)for(let r of e){let[n,s,o]=this.matchRefs(r,i);!n||this.buildThread(r,i,o,s)}return this.runThread()}runThread(){let e=(n,s)=>{if(["ForOfStatement","ForInStatement"].includes(n.graph.type)&&s.every(o=>o.executionPlan.isIterationContractTarget)){let o=s.map(l=>l.executionPlan.iterationTarget);return this.fire(n.graph.lineage,"iterating",s),n.iterate(o)}return this.fire(n.graph.lineage,"executing",s),n.call()},t,i,r;for(;(i=this.$thread.sequence.shift())&&(r=[...this.$thread.entries.get(i)])&&this.$thread.entries.delete(i);)t=m(t,()=>{if(i.disposed||!i.filterRefs(r).length)return;this.$thread.current=i;let n=e(i,r);return m(n,()=>{for(let s of r)[].concat(s.executionPlan.assigneeRef||s.executionPlan.assigneeRefs||[]).forEach(o=>{i.buildThread([],o,[],0)})}),n});return m(t,()=>{let n=this.exits.get("return");return this.exits.clear(),this.$thread.current=null,this.$thread.active=!1,n})}buildThread(e,t,i,r=0,n=!1){let s=r>0;if(this.ownerContract){if(!this.compute(i)||t.condition!==void 0&&!this.assert(t.condition))return}else s||(s=i.length||t.condition!==void 0);let o=n?t.$subscriptions:t.subscriptions;Object.keys(o).forEach(l=>{let[u,h]=l.split(":"),a=f=>{!f||f.selectRefs(h,o[l],s?e:null)},c=this.locate(u);Array.isArray(c)?c.forEach(a):a(c)})}selectRefs(e,t,i=null){let r=this.$thread,n=this.graph.signals[e],s=(l,u)=>l.graph.lineage.localeCompare(u.graph.lineage,void 0,{numeric:!0}),o=(l,u=[],h={})=>{if(!r.active||r.current&&s(this,r.current)<0)return;let a=r.entries.get(this);if(a||(a=new Set,r.entries.set(this,a),r.sequence.push(this),r.sequence.sort(s)),a.add({...l,computes:u,executionPlan:h}),!h.assigneeRef&&["VariableDeclaration","AssignmentExpression"].includes(this.graph.type)){h.assigneeRefs=[];for(let c in this.graph.effects)h.assigneeRefs.push(...this.graph.effects[c].refs)}};for(let l of t){let u=n.refs[l];if(!i){o(u);continue}let[h,a,c]=this.matchRefs(i,u);if(!h)continue;if(a<=0){o(u,c);continue}let f=i.slice(-a),y="assignee"in n?this.graph.effects[n.assignee]:null;if(y){y.refs.forEach(d=>{if(d.depth.length){let[b,g,w]=this.matchRefs(f,d.depth),v=c.concat(w);if(b&&g>0){let P=d.path.concat(f.slice(-g));this.buildThread(P,d,v,g)}else b&&o(u,v,{assigneeRef:d})}else{let b=d.path.concat(f);this.buildThread(b,d,c,a)}});continue}if(a===1&&this.graph.type==="ForOfStatement"){o(u,c,{isIterationContractTarget:!0,iterationTarget:f[0]});continue}if(a===1&&this.graph.type==="ForInStatement"){o(u,c,{isIterationContractTarget:!0,iterationTarget:f[0]});continue}}}filterRefs(e){return e.filter(t=>{if(!!this.compute(t.computes)&&!(t.condition!==void 0&&!this.assert(t.condition)))return!0})}matchRefs(e,t){let i,r,n,s;Array.isArray(e)?(i=e,r=e.dotSafe?e.join("."):void 0):(i=e.path,r=e.$path),Array.isArray(t)?(n=t,s=t.dotSafe?t.join("."):void 0):(n=t.path,s=t.$path);let o=i.length-n.length;if(o>0&&([i,n,r,s]=[n,i,s,r]),r&&s)return[`${s}.`.startsWith(`${r}.`),o,[]];let l=[],u=a=>typeof a=="object"?a.name:a,h=(a,c)=>{if(!a||!c)return!1;let f=typeof a=="object"&&"memoId"in a,y=typeof c=="object"&&"memoId"in c;return f||y?(l.push(d=>(f?d[a.memoId]:u(a))===(y?d[c.memoId]:u(c))),!0):u(a)===u(c)};return[i.reduce((a,c,f)=>a&&h(c,n[f]),!0),o,l]}locate(e){let t=this.graph.lineage+"/",i=e+"/";if(i===t)return this;if(i.startsWith(t)){let r=e.slice(t.length).split("/"),n=this.subContracts.get(parseInt(r.shift()));if(r.length){if(n instanceof Map)return Array.from(n).reduce((s,[o,l])=>s.concat(l.locate(e)),[]);if(n)return n.locate(e)}return n}if(this.ownerContract)return this.ownerContract.locate(e)}compute(e){return!e.some(t=>t(this.contract.memo)===!1)}assert(e){if(typeof e=="string"&&e.includes(":")){let[r,n]=e.split(":");return this.locate(r).assert(n)}let t=this.graph.conditions[e],i=this.contract.memo;return typeof t.parent<"u"&&!this.assert(t.parent)?!1:typeof t.switch<"u"?t.cases.some(r=>i[r]===i[t.switch]):typeof t.whenNot<"u"?!i[t.whenNot]:typeof t.when<"u"?i[t.when]:!0}dispose(){this.params.isFunctionContract||(this.subContracts.forEach((e,t)=>{e instanceof Map?(e.forEach(i=>i.dispose()),e.clear()):e.dispose()}),this.subContracts.clear(),delete this.ownerContract,delete this.callee,delete this.params,delete this.contract.memo,this.disposed=!0)}createFunction(e,t=void 0){let i=e(),r=function(s,...o){let l=s.call(this===void 0?t:this,...o);return s.params.isContractFunction&&s.params.apiVersion>1&&(l=m(l,u=>[u,s.thread.bind(s),s]),i=e(i)),l},n=i instanceof Promise||i.callee instanceof async function(){}.constructor?async function(){return m(i,s=>r.call(this,s,...arguments))}:function(){return r.call(this,i,...arguments)};return m(i,s=>{this.applyReflection(n,s)}),x(n,"properties",m(i,s=>{let o={type:s.params.functionType||"Program",apiVersion:s.params.apiVersion||1,isContractFunction:s.params.isContractFunction,sideEffects:s.graph.sideEffects||!1};if(s.params.isContractFunction){o.dependencies=[];for(let[l,u]of Object.entries(s.graph.effects))o.dependencies.push(...u.refs.map(h=>h.path.map(a=>"name"in a?a.name:1/0)))}return o})),n}applyReflection(e,t){Object.defineProperty(t.callee,"length",{configurable:!0,value:t.callee.length-1});let i=t.callee.toString();Object.defineProperty(t.callee,"toString",{configurable:!0,value:(n=!1)=>!n&&t.graph.originalSource?t.graph.originalSource:i});let r={name:t.callee.name,length:t.callee.length,toString:t.callee.toString};t.params.isContractFunction&&(t.params.apiVersion>1||(r={...r,thread:t.thread.bind(t),dispose:t.dispose.bind(t),runtime:t})),Object.keys(r).forEach(n=>{Object.defineProperty(e,n,{configurable:!0,value:r[n]})})}};var E=class extends C{static create(e,t=[],i={}){let n=i.async||e.graph.hoistedAwaitKeyword?Object.getPrototypeOf(async function(){}).constructor:Function,s=i.compileFunction?i.compileFunction(e.source,[e.identifier+""].concat(t)):new n(e.identifier+"",...t,e.source);return new this(null,e.graph,s,i)}static createFunction(e,t,i=[],r={},n,s=null){r={...r,functionType:"Constructor"},t instanceof Promise&&(r={...r,async:!0});let o=h=>h?new this(null,h.graph,h.callee,r):m(t,a=>l(this.create(a,i,r))),l=h=>{if(h.graph.originalSource&&!h.graph.originalSourceModified){let a=`${r.async||h.graph.hoistedAwaitKeyword?"async ":""}function ${e||"anonymous"}`,c=h.graph.originalSource.split(/\n/g).map(f=>`    ${f}`).join(`
`);h.graph.originalSource=`${a}(${i.join(", ")}) {
${c}
}`,h.graph.originalSourceModified=!0}return e&&Object.defineProperty(h.callee,"name",{configurable:!0,value:e}),h},u=this.prototype.createFunction(o,n);return x(u,"locations",m(t,h=>({locations:h.locations}))),u}};function S(...p){if(typeof window!="object")throw new Error("No window in context.");let e=$(typeof p[p.length-1]=="object"?p.pop():{}),t=O(p.pop()||""),i=p,r=n=>E.createFunction(void 0,n,i,e.runtimeParams,this,t);if(window.webqit?.ContractCompiler&&!e.runtimeParams.async){let{parse:n,compile:s}=window.webqit.ContractCompiler,o=n(t,e.parserParams);return r(s(o,e.compilerParams))}if(window.webqit=window.webqit||{},!window.webqit.ContractCompilerWorker){let o=`
        const compilerUrls = [ '${(document.querySelector('meta[name="contract-compiler-url"]')?.content.split(",")||[]).concat("https://unpkg.com/@webqit/contract/dist/compiler.js").join("','")}' ];
        ( function importScript() {
            try { importScripts( compilerUrls.shift().trim() ) } catch( e ) { if ( compilerUrls.length ) { importScript(); } }
        } )();
        const { parse, compile } = self.webqit.ContractCompiler;
        self.onmessage = e => {
            const { source, params } = e.data;
            const ast = parse( source, params.parserParams );
            const compilation = compile( ast, params.compilerParams );
            compilation.identifier = compilation.identifier.toString();
            e.ports[ 0 ]?.postMessage( compilation );
        };`;window.webqit.ContractCompilerWorker=new Worker(`data:text/javascript;base64,${btoa(o)}`)}return r(new Promise(n=>{let s=new MessageChannel;webqit.ContractCompilerWorker.postMessage({source:t,params:e},[s.port2]),s.port1.onmessage=o=>n(o.data)}))}Object.defineProperty(S,"inspect",{value:x});var j=p=>class extends p{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){[].concat(this.css).forEach(t=>{if(t.includes("{")&&t.includes(":")&&t.includes(";")){let i=this.shadowRoot.appendChild(document.createElement("style"));i.textContent=t}else{let i=this.shadowRoot.appendChild(document.createElement("link"));i.setAttribute("rel","stylesheet"),i.setAttribute("href",t)}})}get css(){return[]}};var F=class extends j(HTMLElement){connectedCallback(){this.autoMode=this.getAttribute("auto-mode"),this.visualizerElement=document.createElement("cfunctions-visualizer"),this.controlsElement=document.createElement("div"),this.controlsElement.classList.add("controls-element"),this.buttons={},["edit","play"].forEach(e=>{let t=e.substring(0,1).toUpperCase()+e.substring(1);this.buttons[e]=this.controlsElement.appendChild(document.createElement("button")),this.buttons[e].classList.add(e),this.buttons[e].setAttribute("title",t);let i=this.buttons[e].appendChild(document.createElement("i"));(this.getAttribute(`data-${e}-icon`)||`bi bi-${e==="edit"?"pencil":e}`).split(" ").map(s=>s.trim()).forEach(s=>i.classList.add(s)),this.buttons[e].appendChild(document.createElement("span")).append(" ",t),this.buttons[e].addEventListener("click",s=>{this.active&&this.active.classList.remove("active"),this.active=this.buttons[e],this.active.classList.add("active")})}),this.buttons.edit.addEventListener("click",e=>this.switchEditable(!0)),this.buttons.play.addEventListener("click",e=>this.switchEditable(!1)),this.shadowRoot.append(this.controlsElement,this.visualizerElement),super.connectedCallback(),setTimeout(()=>{this.visualizerElement.innerHTML=this.innerHTML,setTimeout(()=>{this.loadConsole(),this.autoMode&&this.buttons[this.autoMode].dispatchEvent(new MouseEvent("click"))},0)},0)}loadConsole(){this.fn=S(this.visualizerElement.source,{devMode:!0}),this.visualizerElement.visualize(this.fn,!1)}switchEditable(e){this.visualizerElement.editable=e,e?this.fn&&(this.fn.dispose(),this.fn=null):(this.fn||this.loadConsole(),this.fn())}get css(){return["https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css",`
            * {
                -webkit-box-sizing: border-box;
                -moz-box-sizing: border-box;
                box-sizing: border-box;
            }
            :host {
                position: relative;
                display: block;
                background-color: rgb(75, 75, 75);
            }
            .controls-element button {
                display: inline-flex;
                align-items: center;
                background-color: transparent;
                padding: 0.5rem 1rem;
                border: none;
                color: silver;
            }
            .controls-element button:is(:hover, .active) {
                background-color: var(--active-bg-color, dimgray);
                color: var(--active-color, gainsboro);
            }
            .controls-element button .bi {
                margin-right: 0.5rem;
            }
            .controls-element button .bi.bi-play {
                font-size: larger;
            }

            @media (min-width: 800px) {
                :host(.layout2) {
                    display: flex;
                    display: -webkit-flex;
                }
                :host(.layout2) cfunctions-visualizer {
                    flex-grow: 1;
                }
                :host(.layout2) .controls-element {
                    flex-basis: 1rem;
                }
                :host(.layout2) .controls-element button {
                    width: 100%;
                    text-align: center;
                    display: block;
                    padding: 1rem;
                }
                :host(.layout2) .controls-element button span {
                    display: none;
                }
                :host(.layout2) .controls-element button .bi {
                    margin-right: 0;
                }
            }
            `]}};customElements.define("cfunctions-sandbox",F);})();
//# sourceMappingURL=sandbox-element.js.map
